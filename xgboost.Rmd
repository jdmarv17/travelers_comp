---
title: "xgboost_practice"
author: "Josh Marvald"
date: "11/2/2021"
output: html_document
---

```{r}
library(tidyverse)
library(Matrix)
library(xgboost)
```


```{r}
train <- read_csv("data/train_2021.csv")
train <- na.omit(train)

'%ni%' <- Negate('%in%')
```


```{r}
# weight training data more heavily for fraud cases
fraud_cases <- 
  train %>%
  filter(fraud == 1)

no_fraud <- 
  train %>%
  filter(fraud == 0)

set.seed(123)
fraud_sample <-
  sample(fraud_cases$claim_number, size = 1800)

no_fraud_sample <-
  sample(no_fraud$claim_number, size = 1800)

weighted_train <-
  train %>%
  filter(claim_number %in% fraud_sample | claim_number %in% no_fraud_sample)
```


```{r}
# get numeric
subset <-
  weighted_train %>%
  select(claim_number, marital_status, safty_rating, annual_income, high_education_ind,
         witness_present_ind, policy_report_filed_ind, address_change_ind, past_num_of_claims,
         liab_prct, age_of_vehicle, vehicle_category, gender, claim_est_payout,
         channel, accident_site, claim_day_of_week, living_status, age_of_driver, fraud) %>%
  mutate(day = case_when(
    claim_day_of_week == "Sunday" ~ 0,
    claim_day_of_week == "Monday" ~ 1,
    claim_day_of_week == "Tuesday" ~ 2,
    claim_day_of_week == "Wednesday" ~ 3,
    claim_day_of_week == "Thursday" ~ 4,
    claim_day_of_week == "Friday" ~ 5,
    claim_day_of_week == "Saturday" ~ 6
  )) %>%
  mutate(rent_own = case_when(
    living_status == "Own" ~ 1,
    living_status == "Rent" ~ 0
  )) %>%
  mutate(site = case_when(
    accident_site == "Highway" ~ 0,
    accident_site == "Parking Lot" ~ 1,
    accident_site == "Local" ~ 2
  )) %>%
  mutate(car_size = case_when(
    vehicle_category == "Compact" ~ 0,
    vehicle_category == "Medium" ~ 1,
    vehicle_category == "Large" ~ 2
  )) %>%
  mutate(method = case_when(
    channel == "Broker" ~ 0,
    channel == "Phone" ~ 1,
    channel == "Online" ~ 2
  )) %>%
  mutate(Gender = ifelse(gender == "M", 1, 0)) %>%
  select(claim_number, marital_status, safty_rating, annual_income, high_education_ind,
         witness_present_ind, policy_report_filed_ind, address_change_ind, past_num_of_claims,
         liab_prct, age_of_vehicle, car_size, Gender, claim_est_payout,
         method, site, day, rent_own, age_of_driver, fraud)
```


```{r}
# boosting train/test
boost_set <-
  subset %>%
  select(claim_number, marital_status, witness_present_ind, high_education_ind,
         policy_report_filed_ind, car_size, Gender,
         method, rent_own, age_of_driver, address_change_ind, fraud)

indeces <- sample(boost_set$claim_number, size = 2400)

fraud_train <- 
  boost_set %>%
  filter(claim_number %in% indeces) %>%
  select(fraud)

boost_train <- 
  boost_set %>%
  filter(claim_number %in% indeces) %>%
  select(-fraud)

fraud_train <- as.matrix(fraud_train)
boost_train <- as.matrix(boost_train)
#boost_train <- as(boost_train, "dgCMatrix")

fraud_test <- 
  boost_set %>%
  filter(claim_number %ni% indeces) %>%
  select(fraud)

boost_test <-
  boost_set %>%
  filter(claim_number %ni% indeces) %>%
  select(-fraud)

fraud_test <- as.matrix(fraud_test)
boost_test <- as.matrix(boost_test)
#boost_test <- as(boost_test, "dgCMatrix")
```


```{r}
# fit model
# check out interaction parameter
boost_mod <- xgboost(data = boost_train, label = fraud_train, 
                     nrounds = 100, objecive = "binary:logistic")

probs <- predict(boost_mod, boost_test)
preds <- ifelse(probs >= .5, 1, 0)
```


```{r}
mean(preds == fraud_test)
```



```{r}
test2 <- 
  train %>%
  select(claim_number, marital_status, safty_rating, annual_income, high_education_ind,
         witness_present_ind, policy_report_filed_ind, address_change_ind, past_num_of_claims,
         liab_prct, age_of_vehicle, vehicle_category, gender, claim_est_payout,
         channel, accident_site, claim_day_of_week, living_status, age_of_driver, fraud) %>%
  mutate(day = case_when(
    claim_day_of_week == "Sunday" ~ 0,
    claim_day_of_week == "Monday" ~ 1,
    claim_day_of_week == "Tuesday" ~ 2,
    claim_day_of_week == "Wednesday" ~ 3,
    claim_day_of_week == "Thursday" ~ 4,
    claim_day_of_week == "Friday" ~ 5,
    claim_day_of_week == "Saturday" ~ 6
  )) %>%
  mutate(rent_own = case_when(
    living_status == "Own" ~ 1,
    living_status == "Rent" ~ 0
  )) %>%
  mutate(site = case_when(
    accident_site == "Highway" ~ 0,
    accident_site == "Parking Lot" ~ 1,
    accident_site == "Local" ~ 2
  )) %>%
  mutate(car_size = case_when(
    vehicle_category == "Compact" ~ 0,
    vehicle_category == "Medium" ~ 1,
    vehicle_category == "Large" ~ 2
  )) %>%
  mutate(method = case_when(
    channel == "Broker" ~ 0,
    channel == "Phone" ~ 1,
    channel == "Online" ~ 2
  )) %>%
  mutate(Gender = ifelse(gender == "M", 1, 0)) %>%
  select(claim_number, marital_status, safty_rating, annual_income, high_education_ind,
         witness_present_ind, policy_report_filed_ind, address_change_ind, past_num_of_claims,
         liab_prct, age_of_vehicle, car_size, Gender, claim_est_payout,
         method, site, day, rent_own, age_of_driver, fraud) %>%
  filter(claim_number %ni% subset)

test2_fraud <- 
  test2 %>%
  select(fraud)
test2_fraud <- as.matrix(test2_fraud)

test2 <- 
  test2 %>% 
  select(claim_number, marital_status, witness_present_ind, high_education_ind,
         policy_report_filed_ind, car_size, Gender,
         method, rent_own, age_of_driver, address_change_ind)
test2 <- as.matrix(test2)
```


```{r}
probs2 <- predict(boost_mod, test2)
preds2 <- ifelse(probs2 >= .5, 1, 0)


mean(preds2 == test2_fraud)
```

